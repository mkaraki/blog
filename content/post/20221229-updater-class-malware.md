---
title: マインクラフトにて観測されたUpdater.classマルウェアの検証
date: 2022-12-29T00:00:00+09:00
author: mkaraki
slug: '20221229-updater-class-malware'
---

当記事内には実際に攻撃者が利用したURLなどが無毒化した状態で記述されている。
もし開く場合は自己責任で。

## 時系列

- 2022/12/27 10:18: サーバが正常に起動していない現象を観測
- サーバ管理担当者がサーバを再起動
- `java.net.NoRouteToHostException: No route to host`エラーを観測
- レンタルサーバ事業者にネットワーク設備の点検を依頼
- 2022/12/27 10:30: レンタルサーバ事業者から、障害が発生していない報告を受ける
- マルウェア検査アプリケーションでマルウェアを発見
- 2022/12/28 10:35: 障害の復旧作業に筆者が合流
- 2022/12/29 02:00: 当該障害がクリティカルなセキュリティ事故であることが判明
- 2022/12/30 10:56: 当該サーバが復活し、当初のエラーが出なくなっている可能性があることが発覚  
  これに伴い、VirusTotalの結果を記事内に追記

## はじめに

本記事ではプラグインファイル・Paperバイナリに対して感染した`Updater.class`について取り扱う。

それ以外の項目については、
[こちらの記事(英語)](https://ljskatt.no/analysis/updater_class/)が参考になると思われる。

## エントリーポイントの汚染

複数の`main`メソッドにおいて`Updater.init()`を呼び出すコードが発見されている。

また、コードとして

```java

public static void main (String[] arrstring) {
    Updater.init();
    String[] args;
}
```

のように変更されており、
引数が編集されていることで書き換え済みか認識しているのではないかと考察した。

また、CFRでの解析において`Updater`クラスが認識出来ていなかったが、
おそらく`Updater.class`ファイルに不正な値を入力することで、
解析アプリケーションをまともに動かせなくする目的があったのではないかと考える。

## `Updater.init()`の挙動

リバースエンジニアリングした全文は
[こちら](https://gist.github.com/mkaraki/ea7c4a483cdb78bbdf0dd2cff8cac54a#file-00_updateclass-malware-decompiled-20221229-java)
を参照していただきたい。

また、筆者が必要に応じてアノテーションを付けたファイルは
[こちら](https://gist.github.com/mkaraki/ea7c4a483cdb78bbdf0dd2cff8cac54a#file-01_updateclass-malware-decompiled-annotated-20221229-java)
から利用できる。

### 前提バイナリのロード

`Updater.class`では
最初に`java.io.tmpdir`内の
`kernel-certs-debug4917.log`というファイルに対して
`File`オブジェクトを生成する。

もし、すでに`kernel-certs-debug4917.log`ファイルが存在しているのであれば、
当該ファイルを`java`もしくは`javaw.exe`で実行する。

拡張子は`.log`であり、いかにも一般的なファイルに擬態させているが、中身は`jar`ファイルである。

### バイナリのダウンロード

もし`kernel-certs-debug4917.log`が存在しない場合、次の動作が行われる。

1. 初期値として`0Prpx2ekKWc=`をロード
2. リソース内の`/plugin-config.bin`から`IJMZR7mQs8faH0sBuSYr8g==`をロード
3. `ttp:// files <dot> skyrage <dot> de/mvd`から`jar`ファイルをを`.log`として保存
   ([VirusTotal](https://www.virustotal.com/gui/file/a98cb11c4779fa8b5d81986b2b8e22b1b03e3cce579c2b7b209814cb7e446bfe))
4. `ttp:// files <dot> skyrage <dot> de/update`からzip形式のファイルをダウンロード
   ([VirusTotal](https://www.virustotal.com/gui/file/753579034abcffedd35f0fd9f3eac771b6f63d743194f9c6c2a64fe49db218b7))
5. ダウンロードしたファイルを加工（詳細は割愛）
6. 1もしくは2でロードした値を`-Dgnu`に代入し、ダウンロードしたバイナリを実行

## 追跡

### Whois

Whoisの最終変更は下記のとおりである。

```
Changed: 2021-07-12T21:50:02+02:00
```

また、ネームサーバはCloudflareの物が利用されていたようだ。

## 当該マルウェアについて本チームの考察

共同で研究を行った のふれむ氏 の調べたところによると、
当該マルウェアは2022年の8月ごろから発見されていると見て良いのではないかと思われる。

当チームが観測したバージョンは、
おそらく2022/12/27日時点でCloudflare側が規約違反もしくはFreeプランの制限超過で
Proxyを解除し、それによりCloudflare以外からの通信を拒否していたサーバにアクセスできなくなったことで
`No route to host`がエラーとして出るようになり、発覚に至ったと考えられる。

また、今回感染したファイルは
[MCAntiMalware](https://github.com/OpticFusion1/MCAntiMalware)
と
[Kasperskyのウイルス対策ソフトウェアで検出が可能だった](https://www.virustotal.com/gui/file/20559b330a363cbb4246c7376575319eae926b28801b1d815e5ec7ed24385e90)
ようである。

Pluginを導入する前に
[Virus Total](https://www.virustotal.com/gui/home/upload)
などで検査するだけでも十分防げた可能性は高い。

## 当該のマルウェアに関する他の記事

- https://ljskatt.no/analysis/updater_class/
- https://www.spigotmc.org/threads/1-19-1-fatal-error-converting-plugin-updater-class.567801/
- https://goli-carft.com/minecraft-malware-announcement/
