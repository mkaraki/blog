<!doctype html><html lang=ja-jp dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="当記事内には実際に攻撃者が利用したURLなどが無毒化した状態で記述されている。 もし開く場合は自己責任"><title>マインクラフトにて観測されたUpdater.classマルウェアの検証</title><link rel=canonical href=https://blog.mkarakiapps.com/p/20221229-updater-class-malware/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","8ruafub4am")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7860713879668057" crossorigin=anonymous></script><meta property="og:title" content="マインクラフトにて観測されたUpdater.classマルウェアの検証"><meta property="og:description" content="当記事内には実際に攻撃者が利用したURLなどが無毒化した状態で記述されている。 もし開く場合は自己責任"><meta property="og:url" content="https://blog.mkarakiapps.com/p/20221229-updater-class-malware/"><meta property="og:site_name" content="mkarakiのブログ"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-12-29T00:00:00+09:00"><meta property="article:modified_time" content="2022-12-31T16:58:02+09:00"><meta name=twitter:site content="@arakimk"><meta name=twitter:creator content="@arakimk"><meta name=twitter:title content="マインクラフトにて観測されたUpdater.classマルウェアの検証"><meta name=twitter:description content="当記事内には実際に攻撃者が利用したURLなどが無毒化した状態で記述されている。 もし開く場合は自己責任"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-145365019-1","auto"),ga("send","pageview"))</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>mkarakiのブログ</a></h1><h2 class=site-description>主にコンピュータ関係で躓いたことなとを気まぐれで書いていきます。</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/privacy-policy/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>Privacy Policy</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>ダークモード</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#時系列>時系列</a></li><li><a href=#はじめに>はじめに</a></li><li><a href=#エントリーポイントの汚染>エントリーポイントの汚染</a></li><li><a href=#updaterinitの挙動><code>Updater.init()</code>の挙動</a><ul><li><a href=#前提バイナリのロード>前提バイナリのロード</a></li><li><a href=#バイナリのダウンロード>バイナリのダウンロード</a></li></ul></li><li><a href=#追跡>追跡</a><ul><li><a href=#whois>Whois</a></li></ul></li><li><a href=#当該マルウェアについて本チームの考察>当該マルウェアについて本チームの考察</a></li><li><a href=#当該のマルウェアに関する他の記事>当該のマルウェアに関する他の記事</a></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/20221229-updater-class-malware/>マインクラフトにて観測されたUpdater.classマルウェアの検証</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 29, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>読了時間: 4分</time></div></footer></div></header><section class=article-content><p>当記事内には実際に攻撃者が利用したURLなどが無毒化した状態で記述されている。
もし開く場合は自己責任で。</p><h2 id=時系列>時系列</h2><ul><li>2022/12/27 10:18: サーバが正常に起動していない現象を観測</li><li>サーバ管理担当者がサーバを再起動</li><li><code>java.net.NoRouteToHostException: No route to host</code>エラーを観測</li><li>レンタルサーバ事業者にネットワーク設備の点検を依頼</li><li>2022/12/27 10:30: レンタルサーバ事業者から、障害が発生していない報告を受ける</li><li>マルウェア検査アプリケーションでマルウェアを発見</li><li>2022/12/28 10:35: 障害の復旧作業に筆者が合流</li><li>2022/12/29 02:00: 当該障害がクリティカルなセキュリティ事故であることが判明</li><li>2022/12/30 10:56: 当該サーバが復活し、当初のエラーが出なくなっている可能性があることが発覚<br>これに伴い、VirusTotal, Any.Runの結果を記事内に追記</li><li>2022/12/31 02:00: 感染していた場合でも、エラー無しでサーバが正常に動作することが判明</li></ul><h2 id=はじめに>はじめに</h2><p>本記事ではプラグインファイル・Paperバイナリに対して感染した<code>Updater.class</code>について取り扱う。</p><p>それ以外の項目については、
<a class=link href=https://ljskatt.no/analysis/updater_class/ target=_blank rel=noopener>こちらの記事(英語)</a>が参考になると思われる。</p><p>また、実際に感染したサーバを実行した際の動作について
<a class=link href=https://app.any.run/tasks/4ce2e325-fff6-48c3-8a3f-04e59e998137 target=_blank rel=noopener>Any.Run</a>
で実験を行っている。
そちらも見ていただけると、本記事と別途記述している2記事についてもよくご理解いただけるのではないかと思う。</p><h2 id=エントリーポイントの汚染>エントリーポイントの汚染</h2><p>複数の<code>main</code>メソッドにおいて<code>Updater.init()</code>を呼び出すコードが発見されている。</p><p>また、コードとして</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span> <span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>arrstring</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Updater</span><span class=o>.</span><span class=na>init</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>のように変更されており、
引数が編集されていることで書き換え済みか認識しているのではないかと考察した。</p><p>また、CFRでの解析において<code>Updater</code>クラスが認識出来ていなかったが、
おそらく<code>Updater.class</code>ファイルに不正な値を入力することで、
解析アプリケーションをまともに動かせなくする目的があったのではないかと考える。</p><h2 id=updaterinitの挙動><code>Updater.init()</code>の挙動</h2><p>リバースエンジニアリングした全文は
<a class=link href=https://gist.github.com/mkaraki/ea7c4a483cdb78bbdf0dd2cff8cac54a#file-00_updateclass-malware-decompiled-20221229-java target=_blank rel=noopener>こちら</a>
を参照していただきたい。</p><p>また、筆者が必要に応じてアノテーションを付けたファイルは
<a class=link href=https://gist.github.com/mkaraki/ea7c4a483cdb78bbdf0dd2cff8cac54a#file-01_updateclass-malware-decompiled-annotated-20221229-java target=_blank rel=noopener>こちら</a>
から利用できる。</p><h3 id=前提バイナリのロード>前提バイナリのロード</h3><p><code>Updater.class</code>では
最初に<code>java.io.tmpdir</code>内の
<code>kernel-certs-debug4917.log</code>というファイルに対して
<code>File</code>オブジェクトを生成する。</p><p>もし、すでに<code>kernel-certs-debug4917.log</code>ファイルが存在しているのであれば、
当該ファイルを<code>java</code>もしくは<code>javaw.exe</code>で実行する。</p><p>拡張子は<code>.log</code>であり、いかにも一般的なファイルに擬態させているが、中身は<code>jar</code>ファイルである。</p><h3 id=バイナリのダウンロード>バイナリのダウンロード</h3><p>もし<code>kernel-certs-debug4917.log</code>が存在しない場合、次の動作が行われる。</p><ol><li>初期値として<code>0Prpx2ekKWc=</code>をロード</li><li>リソース内の<code>/plugin-config.bin</code>から<code>IJMZR7mQs8faH0sBuSYr8g==</code>をロード</li><li><code>ttp:// files &lt;dot> skyrage &lt;dot> de/mvd</code>から<code>jar</code>ファイルをを<code>.log</code>として保存
(<a class=link href=https://www.virustotal.com/gui/file/a98cb11c4779fa8b5d81986b2b8e22b1b03e3cce579c2b7b209814cb7e446bfe target=_blank rel=noopener>VirusTotal</a>,
<a class=link href=../20221231-updater-class-dotlog>詳細記事</a>)</li><li>1もしくは2でロードした値を<code>-Dgnu</code>に代入し、ダウンロードしたバイナリを実行</li><li><code>ttp:// files &lt;dot> skyrage &lt;dot> de/update</code>からzip形式のファイルをダウンロード
(<a class=link href=https://www.virustotal.com/gui/file/753579034abcffedd35f0fd9f3eac771b6f63d743194f9c6c2a64fe49db218b7 target=_blank rel=noopener>VirusTotal</a>,
<a class=link href=https://app.any.run/tasks/7accb28d-a771-4353-bbc6-bf7647c59c47 target=_blank rel=noopener>Any.Run</a>,
<a class=link href=../20221231-updater-class-update>詳細記事</a>)</li><li>ダウンロードしたファイルを加工（詳細は割愛）</li><li>ダウンロードしたファイルを実行</li></ol><h2 id=追跡>追跡</h2><h3 id=whois>Whois</h3><p>Whoisの最終変更は下記のとおりである。</p><pre tabindex=0><code>Changed: 2021-07-12T21:50:02+02:00
</code></pre><p>また、ネームサーバはCloudflareの物が利用されていたようだ。</p><h2 id=当該マルウェアについて本チームの考察>当該マルウェアについて本チームの考察</h2><p>共同で研究を行った のふれむ氏 の調べたところによると、
当該マルウェアは2022年の8月ごろから発見されていると見て良いのではないかと思われる。</p><p>当チームが観測したバージョンは、
おそらく2022/12/27日時点でCloudflare側が規約違反もしくはFreeプランの制限超過で
Proxyを解除し、それによりCloudflare以外からの通信を拒否していたサーバにアクセスできなくなったことで
<code>No route to host</code>がエラーとして出るようになり、発覚に至ったと考えられる。</p><p>また、今回感染したファイルは
<a class=link href=https://github.com/OpticFusion1/MCAntiMalware target=_blank rel=noopener>MCAntiMalware</a>
と
<a class=link href=https://www.virustotal.com/gui/file/20559b330a363cbb4246c7376575319eae926b28801b1d815e5ec7ed24385e90 target=_blank rel=noopener>Kasperskyのウイルス対策ソフトウェアで検出が可能だった</a>
ようである。</p><p>Pluginを導入する前に
<a class=link href=https://www.virustotal.com/gui/home/upload target=_blank rel=noopener>Virus Total</a>
などで検査するだけでも十分防げた可能性は高い。</p><h2 id=当該のマルウェアに関する他の記事>当該のマルウェアに関する他の記事</h2><ul><li><a class=link href=https://ljskatt.no/analysis/updater_class/ target=_blank rel=noopener>https://ljskatt.no/analysis/updater_class/</a></li><li><a class=link href=https://www.spigotmc.org/threads/1-19-1-fatal-error-converting-plugin-updater-class.567801/ target=_blank rel=noopener>https://www.spigotmc.org/threads/1-19-1-fatal-error-converting-plugin-updater-class.567801/</a></li><li><a class=link href=https://goli-carft.com/minecraft-malware-announcement/ target=_blank rel=noopener>https://goli-carft.com/minecraft-malware-announcement/</a></li></ul></section><footer class=article-footer><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>最終更新 Dec 31, 2022 16:58 PM JST</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2021 -
2023 mkarakiのブログ</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>